name: Build and Upload JAR to S3 (OIDC), Deploy to Lambda

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'pom.xml'
  workflow_dispatch:  # enables manual trigger

permissions:
  id-token: write        # required for OIDC
  contents: read         # allows checkout

jobs:
  deploy:
    runs-on: ubuntu-latest
    # if: "!contains(github.event.head_commit.message, 'dependabot')"

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Build the JAR
        run: mvn clean package -DskipTests

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::897729105223:role/GitHubOIDCDeployRole
          aws-region: eu-west-1

      - name: Upload to S3
        run: |
          JAR_NAME="spring-lambda-mcp-server-1.0.${{ github.run_number }}.jar"
          cp target/spring-lambda-mcp-server-1.0.0-SNAPSHOT.jar target/$JAR_NAME
          aws s3 cp target/$JAR_NAME s3://maven-releases-897729105223-eu-west-1/builds/

      - name: Deploy Lambda with Validation
        run: |
          JAR_NAME="spring-lambda-mcp-server-1.0.${{ github.run_number }}.jar"
          
          # Update function code
          aws lambda update-function-code \
            --function-name spring-lambda-mcp-server \
            --s3-bucket maven-releases-897729105223-eu-west-1 \
            --s3-key builds/$JAR_NAME
          
          # Wait for update to complete
          aws lambda wait function-updated \
            --function-name spring-lambda-mcp-server
          
          # Publish new version
          VERSION=$(aws lambda publish-version \
            --function-name spring-lambda-mcp-server \
            --description "Build ${{ github.run_number }}" \
            --query 'Version' --output text)
          
          # Wait for version to be active
          aws lambda wait function-active-v2 \
            --function-name spring-lambda-mcp-server:$VERSION
          
          # Test the new version
          aws lambda invoke \
            --function-name spring-lambda-mcp-server:$VERSION \
            --cli-binary-format raw-in-base64-out \
            --payload '{"resource":"/actuator/health","path":"/actuator/health","httpMethod":"GET","requestContext":{"resourcePath":"/actuator/health","httpMethod":"GET","requestId":"test-123","identity":{"sourceIp":"127.0.0.1"}},"isBase64Encoded":false}' \
            response.json
          
          # Only if test passes, update alias and cleanup
          if [ $? -eq 0 ]; then
            echo "Version $VERSION validation passed, updating alias..."
            aws lambda update-alias \
              --function-name spring-lambda-mcp-server \
              --name dev \
              --function-version $VERSION
            echo "Deployed version $VERSION to dev alias"
          
            # Immediate cleanup after successful deployment
            echo "Health check passed - cleaning up all versions and JARs..."
          
            # Delete all old Lambda versions (keep only $LATEST + current alias version)
            aws lambda list-versions-by-function \
              --function-name spring-lambda-mcp-server \
              --query 'Versions[?Version!=`$LATEST`].Version' \
              --output text | \
            tr '\t' '\n' | \
            while read old_version; do
              if [ "$old_version" != "$VERSION" ]; then
                echo "Deleting Lambda version: $old_version"
                aws lambda delete-function \
                  --function-name spring-lambda-mcp-server:$old_version
              fi
            done
          
            # Delete ALL JAR files from S3 (no need to keep any after deployment)
            aws s3api list-objects-v2 \
              --bucket maven-releases-897729105223-eu-west-1 \
              --prefix builds/spring-lambda-mcp-server- \
              --query 'Contents[?ends_with(Key, `.jar`)].Key' \
              --output text | \
            tr '\t' '\n' | \
            while read jar_file; do
              echo "Deleting JAR: $jar_file"
              aws s3 rm "s3://maven-releases-897729105223-eu-west-1/$jar_file"
            done
          
            echo "Cleanup completed - Lambda has $LATEST + version $VERSION, S3 cleared"
          else
            echo "Version $VERSION failed validation"
            exit 1
          fi